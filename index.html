<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Talent Directory</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  .profile { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 8px; }
  .hidden { display: none; }
  button { margin-top: 10px; }
</style>
</head>
<body>
<h1>Talent Directory</h1>

<input type="text" id="searchInput" placeholder="Search by name, skills, or tools">
<button id="viewAll">View All Profiles</button>

<div id="profilesContainer"></div>

<!-- Form popup -->
<div id="popup" class="hidden">
  <h3>Enter your details before viewing</h3>
  <input id="email" placeholder="Your Email"><br>
  <input id="account" placeholder="Account"><br>
  <input id="profiling" placeholder="Profiling (e.g., OBPH, UA, etc.)"><br>
  <button id="submitInfo">Submit</button>
</div>

<script>
const SHEET_API_URL = "https://https://script.google.com/macros/s/AKfycbyYHr23yFW26GokRPSo3WC9WehxMaKicEg7pzaLQLyMdbEXzsuVEvF3CLyPoVvyH_ZWjg/exec"; // the GET URL returning your profiles
const LOG_API_URL = "https://script.google.com/macros/s/AKfycbyoy8Bg03Hiw9Q04JYs4MlX1iiBLKaqLCWKfEla1P9wY24eJAUs-v5HVcPsOOScQlnAzA/exec"; // your deployed Apps Script Web App

let selectedProfile = null;
let profiles = [];

// Fetch and display all profiles
async function loadProfiles() {
  try {
    const res = await fetch(SHEET_API_URL);
    profiles = await res.json();
    showProfiles(profiles);
  } catch (err) {
    console.error("Error loading profiles:", err);
  }
}

function showProfiles(data) {
  const container = document.getElementById("profilesContainer");
  container.innerHTML = "";
  if (!data.length) return (container.innerHTML = "<p>No profiles found.</p>");
  data.forEach(p => {
    const div = document.createElement("div");
    div.className = "profile";
    div.innerHTML = `
      <img src="${p.Photo}" alt="${p.Name}" width="100"><br>
      <strong>${p.Name}</strong><br>
      Role: ${p.Role}<br>
      Status: ${p.Status}<br>
      Skills: ${p.Skills}<br>
      Tools: ${p.Tools}<br>
      Experience: ${p.Experience}<br>
      Courses: ${p.Courses}<br>
      <button onclick="openPopup('${p.Name}','${p.Video}','${p.Writeup}')">View Links</button>
    `;
    container.appendChild(div);
  });
}

function openPopup(name, video, writeup) {
  selectedProfile = { name, video, writeup };
  document.getElementById("popup").classList.remove("hidden");
}

document.getElementById("submitInfo").addEventListener("click", async () => {
  const email = document.getElementById("email").value.trim();
  const account = document.getElementById("account").value.trim();
  const profiling = document.getElementById("profiling").value.trim();

  if (!email || !account || !profiling) {
    alert("Please fill out all fields.");
    return;
  }

  try {
    const res = await fetch(LOG_API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        name: selectedProfile.name,
        email,
        account,
        profiling
      })
    });
    const data = await res.json();

    if (!data.success) throw new Error(data.error);

    document.getElementById("popup").classList.add("hidden");

    alert("Access logged. You can now view the profile links.");

    // Show links
    window.open(selectedProfile.video, "_blank");
    window.open(selectedProfile.writeup, "_blank");
  } catch (err) {
    console.error(err);
    alert("Error logging access.");
  }
});

document.getElementById("searchInput").addEventListener("input", e => {
  const query = e.target.value.toLowerCase();
  const results = profiles.filter(p =>
    [p.Name, p.Skills, p.Tools].some(field =>
      field.toLowerCase().includes(query)
    )
  );
  showProfiles(results);
});

document.getElementById("viewAll").addEventListener("click", () => showProfiles(profiles));

loadProfiles();
</script>
</body>
</html>
